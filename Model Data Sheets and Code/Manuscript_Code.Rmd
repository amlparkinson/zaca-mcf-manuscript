---
title: "Zaca Fire Type Conversion"
date: "7/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Prepare Workspace

```{r load_libraries}

library(tidyverse)
library(raster)
library(randomForest)
library(VSURF)
library(ALEplot)

setwd("E:/zaca/type_conversion")

set.seed(2020) #Set seed so random forests are replicable

UTM_11N <- CRS("+proj=utm +zone=11 +ellps=WGS84 +datum=WGS84 +units=m +no_defs ")

```

## Prepare Imagery Data

### Load Function to Pre-process Landsat

The Landsat pre-processing function is stored in a separate file. For each image, it stacks the Landsat bands into a single image file. It then masks erroneous reflectance retrievals, masks clouds, and saves the new image. The function automatically iterates over every data set in a subdirectory.

```{r}

source("preprocessLandsat.R")

```

### Pre-process Landsat Images

```{r}

preprocessLandsat("E:/zaca/type_conversion/Imagery")

```

### Calculate NBR

```{r}

#Directory will all pre-processed Landsat images
setwd("E:/zaca/type_conversion/Imagery/Level2")

for(img in list.files(path = ".", "GTiff$")){
  
  print(paste("Processing ", substr(img, 18, 25), sep = ""))
  
  #Merge bands into a brick
  image <- brick(img)
  
  NAvalue(image) <- -9999
  
  #Check sensor ID, mask using QA layer, and then compute NBR using appropriate formula
  if(as.numeric(substr(img, 3, 4)) == 8){

    print("Recognized Landsat 8")
    
    #Band designations change, depending on whether the OLI aerosol band is included
    if(nlayers(image) == 7){nbr <- (image[[5]] - image[[7]])/(image[[5]] + image[[7]])}
    else if(nlayers(image) == 6){nbr <- (image[[4]] - image[[6]])/(image[[4]] + image[[6]])}
    else {print("Incorrect number of bands")}
    
  } else if(as.numeric(substr(img, 3, 4)) == 5 | as.numeric(substr(img, 3, 4)) == 7) {
    
    print("Recognized Landsat 5 or 7")
    
    #Band 7 is the sixth band in the brick for TM/ETM
    if(nlayers(image) == 6){nbr <- (image[[4]] - image[[6]])/(image[[4]] + image[[6]])}
    else {print("Incorrect number of bands")}
    
    } else {print("Error recognizing sensor")}
  
  writeRaster(nbr, filename = paste("NBR_", substr(img, 18, 25), ".tif", sep = ""), format = "GTiff", NAflag = -9999)
  assign(paste("NBR_", substr(img, 18, 25)), nbr)
  
  rm(image, image_brick, nbr)
  
  print("Image completed")
  
}

```

### Calculate RdNBR

```{r}

NBR_brick <- brick(NBR_2000, NBR_2001, NBR_2002, NBR_2003, NBR_2004, NBR_2005, NBR_2006, NBR_2007) * 1000

baseline_NBR <- calc(NBR_brick[[1:7]], fun = median)

RdNBR_2007 <- (baseline_NBR - NBR_brick[[8]]) / sqrt(abs(baseline_NBR/1000))

```

## Prepare Vector Data

### Fire History

#### Load Fire History Data

```{r}

#Load Fires
firep19_1 <- shapefile("./fire19_1/firep19_1.shp")

#Rename Columns
names(firep19_1@data)[which(names(firep19_1@data) == "ALARM_DATE")] <- "START_DATE"
names(firep19_1@data)[which(names(firep19_1@data) == "CONT_DATE")] <- "END_DATE"
names(firep19_1@data)[which(names(firep19_1@data) == "YEAR_")] <- "YEAR"

#Load Prescribed Burns
rxburn19_1 <- shapefile("./fire19_1/rxburn19_1.shp")

#Rename Columns
names(rxburn19_1@data)[which(names(rxburn19_1@data) == "TREATMENT1")] <- "FIRE_NAME"
names(rxburn19_1@data)[which(names(rxburn19_1@data) == "YEAR_")] <- "YEAR"

#Combine Layers
fire_history <- bind(firep19_1, rxburn19_1)

#Change Column Data Types
fire_history$YEAR <- as.numeric(fire_history$YEAR)

#Select Columns
fire_history <- fire_history[, c("FIRE_NAME", "YEAR")]

```

#### Calculate Years Since Fire

```{r}

#Extract Zaca burn scar
zaca <- subset(fire_history, FIRE_NAME == "ZACA" & YEAR == 2007)

#Extract fires before Zaca
fires_before_zaca <- subset(fire_history, YEAR < 2007)

#Calculate years since last burn
fires_within_zaca_scar <- intersect(zaca, fires_before_zaca)
fires_within_zaca_scar$years_since_fire <- fires_within_zaca_scar$YEAR.1 - fires_within_zaca_scar$YEAR.2

#Reproject to UTM Zone 11N
fires_within_zaca_scar <- spTransform(fires_within_zaca_scar, UTM_11N)

```

#### Reproject Zaca Boundary

```{r}

zaca <- spTransform(zaca, UTM_11N)

```

### Vegetation Cover

```{r}

south_coast_vegetation <- shapefile("RVMid_R05_SouCoast.shp") %>% 
  crop(., zaca)

central_coast_vegetation <- shapefile("RVMid_R05_CentralCoast.shp") %>% 
  crop(., zaca)

zaca_vegetation <- merge(south_coast_vegetation, central_coast_vegetation)

```


## Prepare Environmental Variables

## Create Raster Templates

The templates have the correct projection, extent, origin, and spatial resolution for the environmental variables. The environmental variables will be reprojected to line up with the templates. The pixel grid is derived from the Landsat images. The topographic variables and insolation will be analyzed at a 10 m spatial resolution. The other variables will be analyzed at a 30 m spatial resolution.

```{r}

template_30m <- raster(landsat_2006[[1]]) %>% 
  crop(., y = zaca)

template_10m <- raster(landsat_2006[[1]]) %>% 
  crop(., y = zaca) %>% 
  disaggregate(., fact = 3)

```


### Prepare Digital Elevation Model

```{r dem}

dem120 <- raster("C:/Users/Christopher/Downloads/USGS_13_n35w120.tif")
dem121 <- raster("C:/Users/Christopher/Downloads/USGS_13_n35w121.tif")

usgs_dem <- merge(dem120, dem121) %>% 
  projectRaster(., to = template_10m, method = "bilinear")

#dem <- raster("E:/zaca/environmental_data/all_variables/dem_10m_zaca.tif")

```


### Prepare Topography Data

```{r topography}

slope <- terrain(x = usgs_dem, opt = "slope", unit = "degrees", neighbors = 8)

aspect <- terrain(x = usgs_dem, opt = "aspect", unit = "degrees", neighbors = 8)

tpi <- terrain(x = usgs_dem, opt = "TPI") #Can calculate larger moving windows manually

```

### Prepare Climate Data

```{r climate}

jan_max_vpd_30yr <- raster("E:/zaca/environmental_data/cwd_vpd_amp/PRISM_vpdmax_30yr_normal_800mM2_01_asc/PRISM_vpdmax_30yr_normal_800mM2_01_asc.asc") %>% 
  projectRaster(., template_30m, method = "ngb") %>% 
  crop(., zaca) %>% 
  mask(., zaca)

jan_min_temp_30yr <- raster("E:/zaca/type_conversion/Environmental_Variables/Climate/January_Min_Temperature/PRISM_tmin_30yr_normal_800mM2_01_asc/PRISM_tmin_30yr_normal_800mM2_01_asc.asc") %>% 
  projectRaster(., template_30m, method = "ngb") %>% 
  crop(., zaca) %>% 
  mask(., zaca)

aug_max_temp_30yr <- raster("E:/zaca/type_conversion/Environmental_Variables/Climate/August_Max_Temperature/PRISM_tmax_30yr_normal_800mM2_08_asc/PRISM_tmax_30yr_normal_800mM2_08_asc.asc") %>% 
  projectRaster(., template_30m, method = "ngb") %>% 
  crop(., zaca) %>% 
  mask(., zaca)

aug_max_vpd_30yr <- raster("E:/zaca/type_conversion/Environmental_Variables/Climate/August_Max_VPD/PRISM_vpdmax_30yr_normal_800mM2_08_asc/PRISM_vpdmax_30yr_normal_800mM2_08_asc.asc") %>% 
  projectRaster(., template_30m, method = "ngb") %>% 
  crop(., zaca) %>% 
  mask(., zaca)

annual_precip_30yr <- raster("E:/zaca/type_conversion/Environmental_Variables/Climate/Annual_Precipitation/PRISM_ppt_30yr_normal_800mM2_annual_asc/PRISM_ppt_30yr_normal_800mM2_annual_asc.asc") %>% 
  projectRaster(., template_30m, method = "ngb") %>% 
  crop(., zaca) %>% 
  mask(., zaca)

#Add Insolation

```

### Prepare Weather Data

```{r}

jan_min_temp_2007 <- raster("E:/zaca/type_conversion/Environmental_Variables/Weather/January_Min_Temp/PRISM_tmin_stable_4kmM3_200701_bil/PRISM_tmin_stable_4kmM3_200701_bil.bil") %>% 
  projectRaster(., template_30m, method = "ngb") %>% 
  crop(., zaca) %>% 
  mask(., zaca)

aug_max_temp_2006 <- raster("E:/zaca/type_conversion/Environmental_Variables/Climate/August_Max_Temperature/PRISM_tmax_30yr_normal_800mM2_08_asc/PRISM_tmax_30yr_normal_800mM2_08_asc.asc") %>% 
  projectRaster(., template_30m, method = "ngb") %>% 
  crop(., zaca) %>% 
  mask(., zaca)

aug_max_vpd_2006 <- raster("E:/zaca/type_conversion/Environmental_Variables/Weather/August_Max_VPD/PRISM_vpdmax_stable_4kmM3_200608_bil/PRISM_vpdmax_stable_4kmM3_200608_bil.bil") %>% 
  projectRaster(., template_30m, method = "ngb") %>% 
  crop(., zaca) %>% 
  mask(., zaca)

annual_precip_30yr <- raster("E:/zaca/type_conversion/Environmental_Variables/Climate/Annual_Precipitation/PRISM_ppt_30yr_normal_800mM2_annual_asc/PRISM_ppt_30yr_normal_800mM2_annual_asc.asc") %>% 
  projectRaster(., template_30m, method = "ngb") %>% 
  crop(., zaca) %>% 
  mask(., zaca)

#Calculate precipitation for preceding year?

```

## Mixed Conifer Forest

### Extract Values

```{r}

mixed_conifer_env <- extract()

```

### Stepwise Variable Selection

```{r}

#Extract prediction and response variables
mcf.predictors <- mixed_conifer_env[,2:ncol(mixed_conifer_env)]
mcf.response <- mixed_conifer_env[,1]

#Run stepwise variable selection algorithm
mcf.vsurf <- VSURF(x = mcf.predictors, y = mcf.response)

#Get names of selected variables
names(mcf.predictors[mcf.vsurf$varselect.pred])

```

# Tuning Parameters

source: https://arxiv.org/pdf/1804.03515.pdf (see digital page 9 for tuneRanger)

options for the measure function: https://mlr.mlr-org.com/articles/tutorial/measures.html


replace: dataframe and response variable 

tunRanger can also be used for ntree, but studies have shown that after a certain number of trees, usually a couple hundred, there is no benefit on accuracy/model fit of increasing ntree, so i fgiure just using a large number will get the same result as whatever number tuneRangere spits out. 
```{r}
set.seed(1127)

# run tuneRanger
mcf_task <- makeClassifTask(data = dataframe, target = "y variable")
tune_output <- tuneRanger(mcf_task, 
                          measure = list(mmce), 
                          num.trees = 1500, 
                          tune.parameters = c("mtry", "min.node.size"))

# recommended parameter settings
# get best parameter values
tune_output$model

```
get error when I try to add "replace" as a tuning parameter :(

### Random Forest

```{r}

#Create random forest using selected variables
mixed_conifer_rf <- randomForest(RdNBR_2007 ~ var1 + var2 + var3, 
                                 data = mixed_conifer_env, 
                                 importance = TRUE, 
                                 na.action = na.omit)

```

